// –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Gemini API —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π

export interface MedicalScenario {
  type: string
  hasCar?: boolean
  shortVersion?: boolean
  severity?: string
  location?: string
  victimName?: string
  additionalDetails?: string
}

export interface GeneratedRoleplay {
  scenario: string
  steps: string[]
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
const PROXY_ENDPOINT = '/api/gemini-proxy'

// –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–±—â–∏—Ö API –∫–ª—é—á–µ–π –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
const DEFAULT_API_KEYS = [
  'AIzaSyBb6hKrJH6k2NsGaFd6cxSHD88OAkmIAHc',
  'AIzaSyBOOcQgu1jfEKSqvRhnyooRXotzItsXNi8'
]

// –ú–µ–Ω–µ–¥–∂–µ—Ä API –∫–ª—é—á–µ–π
class MultiAPIManager {
  private apiKeys: Array<{
    key: string
    requests: number[]
    cooldownUntil: number | null
    failCount: number
  }>
  private currentIndex: number
  private requestsPerMinute: number
  private cooldownTime: number

  constructor(apiKeys: string[], requestsPerMinute = 15) {
    this.apiKeys = apiKeys.map(key => ({
      key,
      requests: [],
      cooldownUntil: null,
      failCount: 0
    }))
    this.currentIndex = 0
    this.requestsPerMinute = requestsPerMinute
    this.cooldownTime = 60000 // 1 –º–∏–Ω—É—Ç–∞
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ API –∫–ª—é—á
  private isKeyAvailable(keyData: typeof this.apiKeys[0]): boolean {
    const now = Date.now()
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ 429
    if (keyData.cooldownUntil && now < keyData.cooldownUntil) {
      return false
    }
    
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å—Ç–∞—Ä—à–µ 1 –º–∏–Ω—É—Ç—ã)
    keyData.requests = keyData.requests.filter(time => now - time < 60000)
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
    return keyData.requests.length < this.requestsPerMinute
  }

  // –ù–∞—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π API –∫–ª—é—á
  private getNextAvailableKey(): typeof this.apiKeys[0] | null {
    const startIndex = this.currentIndex
    
    do {
      const keyData = this.apiKeys[this.currentIndex]
      
      if (this.isKeyAvailable(keyData)) {
        return keyData
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á
      this.currentIndex = (this.currentIndex + 1) % this.apiKeys.length
      
    } while (this.currentIndex !== startIndex)
    
    return null // –í—Å–µ –∫–ª—é—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
  }

  // –û—Ç–º–µ—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞
  private markKeyUsed(keyData: typeof this.apiKeys[0]): void {
    keyData.requests.push(Date.now())
    keyData.failCount = 0
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
    this.currentIndex = (this.currentIndex + 1) % this.apiKeys.length
  }

  // –û—Ç–º–µ—á–∞–µ—Ç –∫–ª—é—á –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ 429
  private markKeyExhausted(keyData: typeof this.apiKeys[0]): void {
    keyData.cooldownUntil = Date.now() + this.cooldownTime
    keyData.failCount++
    console.log(`üî¥ API –∫–ª—é—á ...${keyData.key.slice(-8)} –≤ cooldown –Ω–∞ ${this.cooldownTime / 1000}—Å`)
  }

  // –ü–æ–ª—É—á–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–ª—é—á–µ–π
  private getMinCooldownTime(): number {
    const now = Date.now()
    let minWait = this.cooldownTime
    
    for (const keyData of this.apiKeys) {
      if (keyData.cooldownUntil && keyData.cooldownUntil > now) {
        const wait = keyData.cooldownUntil - now
        if (wait < minWait) {
          minWait = wait
        }
      }
    }
    
    return minWait
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∫–ª—é—á–µ–π
  async executeRequest(
    apiCallFactory: (apiKey: string) => Promise<any>,
    onProgress?: (status: string) => void,
    maxRetries = 5
  ): Promise<any> {
    let lastError: Error | null = null
    let attemptsWithoutKey = 0
    
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      const keyData = this.getNextAvailableKey()
      
      if (!keyData) {
        attemptsWithoutKey++
        
        // –ï—Å–ª–∏ –≤—Å–µ –∫–ª—é—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥
        if (attemptsWithoutKey >= 2) {
          const waitTime = this.getMinCooldownTime()
          const waitSeconds = Math.ceil(waitTime / 1000)
          console.log(`‚è≥ –í—Å–µ API –∫–ª—é—á–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –û–∂–∏–¥–∞–Ω–∏–µ ${waitSeconds}—Å...`)
          
          if (onProgress) {
            onProgress(`‚è≥ –í—Å–µ –∫–ª—é—á–∏ –∑–∞–Ω—è—Ç—ã. –û–∂–∏–¥–∞–Ω–∏–µ ${waitSeconds} —Å–µ–∫...`)
          }
          
          await new Promise(resolve => setTimeout(resolve, waitTime))
          attemptsWithoutKey = 0
          continue
        }
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        await new Promise(resolve => setTimeout(resolve, 1000))
        continue
      }
      
      try {
        console.log(`üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º API –∫–ª—é—á ...${keyData.key.slice(-8)} (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries})`)
        
        if (onProgress) {
          onProgress(`üîë –ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/${maxRetries}...`)
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–∫—É—â–∏–º –∫–ª—é—á–æ–º
        const result = await apiCallFactory(keyData.key)
        
        // –£—Å–ø–µ—Ö - –æ—Ç–º–µ—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
        this.markKeyUsed(keyData)
        console.log(`‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`)
        
        if (onProgress) {
          onProgress(`‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!`)
        }
        
        return result
        
      } catch (error) {
        lastError = error instanceof Error ? error : new Error(String(error))
        
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 429 - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª—é—á
        if (lastError.message.includes('429') || lastError.message.includes('Resource exhausted')) {
          console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ 429 —Å –∫–ª—é—á–æ–º ...${keyData.key.slice(-8)}`)
          this.markKeyExhausted(keyData)
          
          if (onProgress) {
            onProgress(`‚ö†Ô∏è –ö–ª—é—á –∑–∞–Ω—è—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –¥—Ä—É–≥–æ–π...`)
          }
          
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
          await new Promise(resolve => setTimeout(resolve, 500))
          continue
        }
        
        // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ - –ø–æ–≤—Ç–æ—Ä—è–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        console.log(`‚ùå –û—à–∏–±–∫–∞: ${lastError.message}`)
        const delay = Math.min(1000 * Math.pow(2, attempt), 8000)
        
        if (onProgress) {
          onProgress(`‚ö†Ô∏è –û—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${Math.ceil(delay / 1000)} —Å–µ–∫...`)
        }
        
        await new Promise(resolve => setTimeout(resolve, delay))
      }
    }
    
    // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
    throw lastError || new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫')
  }
}

// –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞
const apiManager = new MultiAPIManager(DEFAULT_API_KEYS)

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—ã–≥—Ä–æ–≤–∫—É –ü–ú–ü —Å –ø–æ–º–æ—â—å—é Gemini API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
 */
export async function generateMedicalRoleplay(
  scenario: MedicalScenario,
  userApiKey?: string
): Promise<GeneratedRoleplay> {
  const prompt = buildPrompt(scenario)

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Å–≤–æ–π –∫–ª—é—á, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
  if (userApiKey && userApiKey.trim() !== '' && validateApiKey(userApiKey)) {
    console.log('üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π API –∫–ª—é—á')
    try {
      const response = await fetch(PROXY_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt: prompt,
          apiKey: userApiKey
        })
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}))
        throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} - ${errorData.details || errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`)
      }

      const data = await response.json()
      
      if (!data.success || !data.text) {
        throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤')
      }

      return parseGeneratedText(data.text, scenario)
    } catch (error) {
      if (error instanceof Error) {
        throw new Error(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`)
      }
      throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏')
    }
  }

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–±—â–∏—Ö –∫–ª—é—á–µ–π
  console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º—É —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ API –∫–ª—é—á–∞–º–∏')
  
  try {
    const result = await apiManager.executeRequest(async (apiKey: string) => {
      const response = await fetch(PROXY_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt: prompt,
          apiKey: apiKey
        })
      })

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}))
        throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} - ${errorData.details || errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`)
      }

      const data = await response.json()
      
      if (!data.success || !data.text) {
        throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤')
      }

      return data.text
    })

    return parseGeneratedText(result, scenario)

  } catch (error) {
    if (error instanceof Error) {
      throw new Error(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`)
    }
    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏')
  }
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Gemini –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
 */
function buildPrompt(scenario: MedicalScenario): string {
  const { type, hasCar, shortVersion } = scenario
  const carStatus = hasCar ? '–ï–°–¢–¨ —Å–ª—É–∂–µ–±–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å' : '–ù–ï–¢ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è'
  const versionType = shortVersion ? '–ö–û–†–û–¢–ö–ê–Ø (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–º—É)' : '–ü–û–õ–ù–ê–Ø (—Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏)'

  return `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ú–í–î –ü—Ä–æ–≤–∏–Ω—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –ø–æ–º–æ—â—å. –°–æ–∑–¥–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –æ—Ç—ã–≥—Ä–æ–≤–∫—É –¥–ª—è —Ä–æ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ GTA SAMP —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–∞–Ω–æ–Ω–∞–º Role Play.

–°–¶–ï–ù–ê–†–ò–ô:
- –¢–∏–ø —Ç—Ä–∞–≤–º—ã: ${type}
- –ù–∞–ª–∏—á–∏–µ –º–∞—à–∏–Ω—ã: ${carStatus}
- –í–µ—Ä—Å–∏—è –æ—Ç—ã–≥—Ä–æ–≤–∫–∏: ${versionType}

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:

1. –ö–û–ú–ê–ù–î–ê /me (–¥–µ–π—Å—Ç–≤–∏—è –æ—Ç 3-–≥–æ –ª–∏—Ü–∞):
   - –ü–∏—à–µ—Ç—Å—è —Å –ú–ê–õ–ï–ù–¨–ö–û–ô –±—É–∫–≤—ã (–ø–µ—Ä–µ–¥ –Ω–µ–π —Å—Ç–æ–∏—Ç –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞)
   - ‚ö†Ô∏è –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û —Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ /me –∫–æ–º–∞–Ω–¥—ã! ‚ö†Ô∏è
   - –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏: "/me –¥–æ—Å—Ç–∞–ª –ø–µ—Ä—á–∞—Ç–∫–∏." ‚ùå
   - –í–°–ï–ì–î–ê –ø–∏—à–∏: "/me –¥–æ—Å—Ç–∞–ª –ø–µ—Ä—á–∞—Ç–∫–∏" ‚úÖ
   - –û–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–ª—å–∑—è –ø–æ–∫–∞–∑–∞—Ç—å –≤ –∏–≥—Ä–µ
   - –ú–æ–∂–Ω–æ –æ—Ç—ã–≥—Ä—ã–≤–∞—Ç—å 2-4 —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è –≤ –æ–¥–Ω–æ–º /me
   - –ü—Ä–∏–º–µ—Ä: /me –¥–æ—Å—Ç–∞–ª –∏–∑ –∫–∞—Ä–º–∞–Ω–∞ –ø–∞—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ—Ç—è–Ω—É–ª –µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É

2. –ö–û–ú–ê–ù–î–ê /do (–æ–ø–∏—Å–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –ø—Ä–µ–¥–º–µ—Ç–æ–≤, —Å–æ—Å—Ç–æ—è–Ω–∏—è):
   - –ü–∏—à–µ—Ç—Å—è —Å –ë–û–õ–¨–®–û–ô –±—É–∫–≤—ã
   - –° —Ç–æ—á–∫–æ–π –≤ –∫–æ–Ω—Ü–µ (–∏–ª–∏ "?" –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤)
   - –û–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ, —á–µ–≥–æ –Ω–µ –≤–∏–¥–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ
   - –ù–ï –ù–£–ñ–ù–û –∑–∞–≤–µ—Ä—à–∞—Ç—å –∫–∞–∂–¥—ã–π /me –æ—Ç—ã–≥—Ä–æ–≤–∫–æ–π /do
   - –ó–ê–ü–†–ï–©–ï–ù–´ –æ—Ç—ã–≥—Ä–æ–≤–∫–∏-–ø–∞—Ä–∞–∑–∏—Ç—ã: "/do –£–ª—ã–±–∫–∞ –Ω–∞ –ª–∏—Ü–µ.", "/do –†—É–∫–∞ –≤ –∫–∞—Ä–º–∞–Ω–µ.", "/do –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞."
   - –ò—Å–ø–æ–ª—å–∑—É–π /do —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ
   - –ü—Ä–∏–º–µ—Ä: /do –í –∞–ø—Ç–µ—á–∫–µ –ª–µ–∂–∞—Ç –±–∏–Ω—Ç—ã, –∂–≥—É—Ç –∏ –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫.

3. –ö–û–ú–ê–ù–î–ê /b (OOC —á–∞—Ç):
   - –î–ª—è –≤–Ω–µ–∏–≥—Ä–æ–≤—ã—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π
   - –ü—Ä–∏–º–µ—Ä: /b –ù–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç —á–µ—Ä–µ–∑ /do, —á—Ç–æ —Å –≤–∞–º–∏ —Å–ª—É—á–∏–ª–æ—Å—å

4. –ó–ê–ü–†–ï–¢–´:
   - –ù–ï –æ—Ç—ã–≥—Ä—ã–≤–∞–π –∑–∞ –¥—Ä—É–≥–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
   - –ù–ï –ø–µ—Ä–µ–≤–æ–¥–∏ RP –≤ —Å–≤–æ—é —Å—Ç–æ—Ä–æ–Ω—É
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π /try –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –¥—Ä—É–≥–∏—Ö
   - –ù–ï –ø–∏—à–∏ –æ—Ç—ã–≥—Ä–æ–≤–∫–∏-–ø–∞—Ä–∞–∑–∏—Ç—ã —Ç–∏–ø–∞ "/do –£–ª—ã–±–∫–∞ –Ω–∞ –ª–∏—Ü–µ."
   - –ù–ï –∑–∞–≤–µ—Ä—à–∞–π –∫–∞–∂–¥—ã–π /me –æ—Ç—ã–≥—Ä–æ–≤–∫–æ–π /do –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   - –ù–ï –æ—Ç—ã–≥—Ä—ã–≤–∞–π –í–ò–î–ò–ú–´–ï –¥–µ–π—Å—Ç–≤–∏—è: —Ö–æ–¥—å–±—É, –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–≤–µ—Ä–µ–π –º–∞—à–∏–Ω—ã, –ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–µ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏)
   - –ù–ï –æ—Ç—ã–≥—Ä—ã–≤–∞–π –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: "/me –ø—Ä–æ–≤–µ—Ä–∏–ª –Ω–∞–ª–∏—á–∏–µ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "/do –ú–µ—Å—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?"

5. –°–¢–†–£–ö–¢–£–†–ê –û–¢–´–ì–†–û–í–ö–ò:
   
   –≠–¢–ê–ü 1 - –ü–û–î–ì–û–¢–û–í–ö–ê:
   ${hasCar 
     ? `
   /me –æ—Ç–∫—Ä—ã–ª –±–∞–≥–∞–∂–Ω–∏–∫ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏ –¥–æ—Å—Ç–∞–ª –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é —Å—É–º–∫—É
   /do –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—É–º–∫–∞ –≤ —Ä—É–∫–∞—Ö.`
     : `
   /do –ù–∞ –ø–æ—è—Å–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞.
   /me —Å–Ω—è–ª –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∞–ø—Ç–µ—á–∫—É —Å –ø–æ—è—Å–∞
   /do –ê–ø—Ç–µ—á–∫–∞ –≤ —Ä—É–∫–∞—Ö.`
   }
   
   –≠–¢–ê–ü 2 - –í–´–ó–û–í –°–ö–û–†–û–ô (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º –ü–ú–ü):
   
   –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∏–∂–µ –ö–∞–ø–∏—Ç–∞–Ω–∞:
   /me –¥–æ—Å—Ç–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –≤—ã–∑–≤–∞–ª —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å
   
   –î–ª—è –ö–∞–ø–∏—Ç–∞–Ω–æ–≤ –∏ –≤—ã—à–µ:
   /d [–ì–£–í–î-–ü][–¶–ì–ë-–ü] –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ê–°–ú–ü –∫ "–º–µ—Å—Ç–æ", –ø—Ä–∏—á–∏–Ω–∞: –æ–ø–∏—Å–∞–Ω–∏–µ
   –ü—Ä–∏–º–µ—Ä: /d [–ì–£–í–î-–ü][–¶–ì–ë-–ü] –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ê–°–ú–ü –∫ "–ó–¥–∞–Ω–∏—é –ø–æ–ª–∏—Ü–∏–∏ –≥. –ü—Ä–∏–≤–æ–ª–∂—Å–∫", –ø—Ä–∏—á–∏–Ω–∞: –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω –±–µ–∑ —Å–æ–∑–Ω–∞–Ω–∏—è
   
   –≠–¢–ê–ü 3 - –û–ö–ê–ó–ê–ù–ò–ï –ü–ú–ü:
   ${hasCar 
     ? '/me –æ—Ç–∫—Ä—ã–ª –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é —Å—É–º–∫—É –∏ –¥–æ—Å—Ç–∞–ª –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏'
     : '/me –æ—Ç–∫—Ä—ã–ª –∞–ø—Ç–µ—á–∫—É –∏ –¥–æ—Å—Ç–∞–ª –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–µ—Ä—á–∞—Ç–∫–∏'
   }
   
   –î–∞–ª–µ–µ –ø—Ä–æ–¥–æ–ª–∂–∏ –æ—Å–º–æ—Ç—Ä –∏ –ø–æ–º–æ—â—å
   –ú–∞–∫—Å–∏–º—É–º 10-12 –∫–æ–º–∞–Ω–¥ –¥–ª—è —ç—Ç–∞–ø–∞ –ü–ú–ü

6. –ù–ï–í–ò–î–ò–ú–´–ï –ü–†–ï–î–ú–ï–¢–´:
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç—ã–≥—Ä—ã–≤–∞–π –Ω–∞–ª–∏—á–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ü–ï–†–ï–î –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
   - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—É–º–∫–∞ –Ω–∞ –ø–ª–µ—á–µ: "/do –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—É–º–∫–∞ –ø–µ—Ä–µ–∫–∏–Ω—É—Ç–∞ —á–µ—Ä–µ–∑ –ø–ª–µ—á–æ."
   - –ê–ø—Ç–µ—á–∫–∞ –Ω–∞ –ø–æ—è—Å–µ: "/do –ù–∞ –ø–æ—è—Å–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∞–ø—Ç–µ—á–∫–∞."
   - –ü–µ—Ä—á–∞—Ç–∫–∏ –≤ –∫–∞—Ä–º–∞–Ω–µ: "/do –í –∫–∞—Ä–º–∞–Ω–µ –ª–µ–∂–∞—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –ø–µ—Ä—á–∞—Ç–∫–∏."
   
7. –í–ê–†–ò–ê–¶–ò–ò –° –û–¢–í–ï–¢–ê–ú–ò –ü–û–°–¢–†–ê–î–ê–í–®–ï–ì–û:
   ${shortVersion 
     ? `
   ‚ö†Ô∏è –ö–û–†–û–¢–ö–ê–Ø –í–ï–†–°–ò–Ø - –ë–ï–ó –í–û–ü–†–û–°–û–í –ò –í–ê–†–ò–ê–¶–ò–ô ‚ö†Ô∏è
   
   –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û:
   - –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ /do: "/do –ü—É–ª—å—Å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç?" ‚ùå
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: "/b –û—Ç–≤–µ—Ç –≤ /do –î–∞." ‚ùå
   - –í–∞—Ä–∏–∞—Ü–∏–∏: "‚Äî –ï—Å–ª–∏ –ø—É–ª—å—Å –µ—Å—Ç—å:" ‚ùå
   - –õ—é–±—ã–µ /b –∫–æ–º–∞–Ω–¥—ã ‚ùå
   
   –ü–†–ê–í–ò–õ–¨–ù–û (–∫–æ—Ä–æ—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è):
   /me –ø—Ä–∏–ª–æ–∂–∏–ª –¥–≤–∞ –ø–∞–ª—å—Ü–∞ –∫ —Å–æ–Ω–Ω–æ–π –∞—Ä—Ç–µ—Ä–∏–∏
   /me –æ–±–Ω–∞—Ä—É–∂–∏–ª —Å–ª–∞–±—ã–π –ø—É–ª—å—Å
   /do –ü—É–ª—å—Å —Å–ª–∞–±—ã–π, –Ω–æ –ø—Ä–æ—â—É–ø—ã–≤–∞–µ—Ç—Å—è.
   /me –ø—Ä–æ–¥–æ–ª–∂–∏–ª –æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ
   /me –¥–æ—Å—Ç–∞–ª —Å—Ç–µ—Ä–∏–ª—å–Ω—É—é —Å–∞–ª—Ñ–µ—Ç–∫—É
   /me –ø—Ä–∏–∂–∞–ª —Å–∞–ª—Ñ–µ—Ç–∫—É –∫ —Ä–∞–Ω–µ
   /do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.
   /me –Ω–∞–ª–æ–∂–∏–ª –¥–∞–≤—è—â—É—é –ø–æ–≤—è–∑–∫—É
   
   –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω—ã–µ /do:
   - "/do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è." ‚úÖ
   - "/do –ü—É–ª—å—Å –ø—Ä–æ—â—É–ø—ã–≤–∞–µ—Ç—Å—è." ‚úÖ
   - "/do –ü–µ—Ä–µ–ª–æ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω." ‚úÖ
   
   –ù–ï –ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å—ã:
   - "/do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è?" ‚ùå
   - "/do –ü—É–ª—å—Å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç?" ‚ùå`
     : `
   ‚ö†Ô∏è –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø ‚ö†Ô∏è
   
   –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç–æ:
   /do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è?
   /b –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–π: /do –î–∞.
   
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ /do –ø–∏—Å–∞—Ç—å:
   1. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ: /b –û—Ç–≤–µ—Ç –≤ /do –î–∞. (–ò–ª–∏ /do –ù–µ—Ç.)
   2. –î–í–ê –ü–û–õ–ù–´–• –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π`
   }
   
   –ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢:
   /do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è?
   /b –û—Ç–≤–µ—Ç –≤ /do –î–∞. (–ò–ª–∏ /do –ù–µ—Ç.)
   
   ‚Äî –ï—Å–ª–∏ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è:
   /b –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–π: /do –î–∞.
   /me –ø—Ä–æ–¥–æ–ª–∂–∏–ª –ø—Ä–∏–∂–∏–º–∞—Ç—å —Å–∞–ª—Ñ–µ—Ç–∫—É
   
   ‚Äî –ï—Å–ª–∏ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è:
   /b –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–π: /do –ù–µ—Ç.
   /me –Ω–∞–ª–æ–∂–∏–ª –∂–≥—É—Ç –≤—ã—à–µ –º–µ—Å—Ç–∞ —Ä–∞–Ω–µ–Ω–∏—è
   
   –≠–¢–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–õ–Ø –í–°–ï–• –í–û–ü–†–û–°–û–í:
   - /do –ü—É–ª—å—Å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–µ—Å—Ç—å/–Ω–µ—Ç)
   - /do –î—ã—Ö–∞–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–µ—Å—Ç—å/–Ω–µ—Ç)
   - /do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–¥–∞/–Ω–µ—Ç)
   - /do –ö—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–¥–∞/–Ω–µ—Ç)
   - /do –ü–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–π –≤ —Å–æ–∑–Ω–∞–Ω–∏–∏? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–¥–∞/–Ω–µ—Ç)
   - /do –ü—É–ª—å—Å –ø—Ä–æ—â—É–ø—ã–≤–∞–µ—Ç—Å—è? ‚Üí –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–¥–∞/–Ω–µ—Ç)
   - /do –ü–æ–≤—è–∑–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∞? ‚Üí –ù–ï –ù–£–ñ–ù–ê –≤–∞—Ä–∏–∞—Ü–∏—è (—ç—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –Ω–µ –≤–æ–ø—Ä–æ—Å –∫ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–º—É)
   
   –°–¢–†–£–ö–¢–£–†–ê –û–¢–´–ì–†–û–í–ö–ò:
   1. –î–µ–π—Å—Ç–≤–∏–µ
   2. –í–æ–ø—Ä–æ—Å /do
   3. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å "‚Äî –ï—Å–ª–∏..."
   4. –°–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
   5. –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å /do
   6. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å "‚Äî –ï—Å–ª–∏..."
   –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –ö–ê–ñ–î–û–ì–û –≤–æ–ø—Ä–æ—Å–∞!

8. –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–°–¢–¨:
   - –°–ª–µ–¥—É–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º
   - –î–µ–π—Å—Ç–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏—á–Ω—ã–º–∏ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏
   - –£—á–∏—Ç—ã–≤–∞–π –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
   - –ò—Å–ø–æ–ª—å–∑—É–π –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ /do –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏–π

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ù–∞–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç—ã–≥—Ä–æ–≤–∫–∏, –∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–°–æ–∑–¥–∞–π –æ—Ç—ã–≥—Ä–æ–≤–∫—É:`
}

/**
 * –ü–∞—Ä—Å–∏—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
 */
function parseGeneratedText(text: string, scenario: MedicalScenario): GeneratedRoleplay {
  // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
  const lines = text
    .split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0)
    .filter(line => 
      line.startsWith('/me') || 
      line.startsWith('/do') || 
      line.startsWith('/b') ||
      line.startsWith('/d') ||
      line.includes('–í–∞—Ä–∏–∞–Ω—Ç') ||
      line.includes('–≠–¢–ê–ü') ||
      line.includes('–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤') ||
      line.includes('–î–ª—è –ö–∞–ø–∏—Ç–∞–Ω–æ–≤') ||
      line.startsWith('–ï—Å–ª–∏') ||
      line.startsWith('‚Äî')
    )

  // –°–æ–∑–¥–∞—ë–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
  const scenarioDescription = buildScenarioDescription(scenario)

  return {
    scenario: scenarioDescription,
    steps: lines
  }
}

/**
 * –°–æ–∑–¥–∞—ë—Ç —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
 */
function buildScenarioDescription(scenario: MedicalScenario): string {
  return scenario.type
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
 */
export function validateApiKey(apiKey: string): boolean {
  // Gemini API –∫–ª—é—á–∏ –æ–±—ã—á–Ω–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å "AIza" –∏ –∏–º–µ—é—Ç –¥–ª–∏–Ω—É –æ–∫–æ–ª–æ 39 —Å–∏–º–≤–æ–ª–æ–≤
  return apiKey.startsWith('AIza') && apiKey.length >= 35
}

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç API –∫–ª—é—á –≤ localStorage
 */
export function saveApiKey(apiKey: string): void {
  if (typeof window !== 'undefined') {
    localStorage.setItem('gemini_api_key', apiKey)
  }
}

/**
 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç API –∫–ª—é—á –∏–∑ localStorage
 */
export function loadApiKey(): string | null {
  if (typeof window !== 'undefined') {
    return localStorage.getItem('gemini_api_key')
  }
  return null
}

/**
 * –£–¥–∞–ª—è–µ—Ç API –∫–ª—é—á –∏–∑ localStorage
 */
export function clearApiKey(): void {
  if (typeof window !== 'undefined') {
    localStorage.removeItem('gemini_api_key')
  }
}