// Утилита для работы с Google Gemini API

export interface MedicalScenario {
  type: string
  hasCar?: boolean
  severity?: string
  location?: string
  victimName?: string
  additionalDetails?: string
}

export interface GeneratedRoleplay {
  scenario: string
  steps: string[]
}

// Используем локальный прокси-сервер для обхода региональных ограничений
const PROXY_ENDPOINT = '/api/gemini-proxy'

/**
 * Генерирует отыгровку ПМП с помощью Gemini API через прокси
 */
export async function generateMedicalRoleplay(
  scenario: MedicalScenario,
  apiKey: string
): Promise<GeneratedRoleplay> {
  if (!apiKey || apiKey.trim() === '') {
    throw new Error('API ключ не указан')
  }

  const prompt = buildPrompt(scenario)

  try {
    // Отправляем запрос через наш прокси-сервер
    const response = await fetch(PROXY_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        prompt: prompt,
        apiKey: apiKey
      })
    })

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      throw new Error(`Ошибка API: ${response.status} - ${errorData.details || errorData.error || 'Неизвестная ошибка'}`)
    }

    const data = await response.json()
    
    if (!data.success || !data.text) {
      throw new Error('API не вернул результатов')
    }

    const generatedText = data.text
    return parseGeneratedText(generatedText, scenario)

  } catch (error) {
    if (error instanceof Error) {
      throw new Error(`Ошибка генерации: ${error.message}`)
    }
    throw new Error('Неизвестная ошибка при генерации')
  }
}

/**
 * Строит промпт для Gemini на основе сценария
 */
function buildPrompt(scenario: MedicalScenario): string {
  const { type, hasCar } = scenario
  const carStatus = hasCar ? 'ЕСТЬ служебный автомобиль' : 'НЕТ служебного автомобиля'

  return `Ты - опытный сотрудник МВД Провинции, который оказывает первую медицинскую помощь. Создай реалистичную отыгровку для ролевого сервера GTA SAMP строго по канонам Role Play.

СЦЕНАРИЙ:
- Тип травмы: ${type}
- Наличие машины: ${carStatus}

СТРОГИЕ ПРАВИЛА ОФОРМЛЕНИЯ:

1. КОМАНДА /me (действия от 3-го лица):
   - Пишется с МАЛЕНЬКОЙ буквы (перед ней стоит имя персонажа)
   - БЕЗ точки в конце
   - Описывает действие, которое нельзя показать в игре
   - Можно отыгрывать 2-4 связанных действия в одном /me
   - Пример: /me достал из кармана паспорт и протянул его сотруднику

2. КОМАНДА /do (описание окружения, предметов, состояния):
   - Пишется с БОЛЬШОЙ буквы
   - С точкой в конце (или "?" для вопросов)
   - Описывает то, чего не видно визуально
   - НЕ НУЖНО завершать каждый /me отыгровкой /do
   - ЗАПРЕЩЕНЫ отыгровки-паразиты: "/do Улыбка на лице.", "/do Рука в кармане.", "/do Передача паспорта."
   - Используй /do только когда нужно описать неочевидное
   - Пример: /do В аптечке лежат бинты, жгут и антисептик.

3. КОМАНДА /b (OOC чат):
   - Для внеигровых уточнений
   - Пример: /b Напишите в чат через /do, что с вами случилось

4. ЗАПРЕТЫ:
   - НЕ отыгрывай за другого персонажа
   - НЕ переводи RP в свою сторону
   - НЕ используй /try для определения состояния здоровья других
   - НЕ пиши отыгровки-паразиты типа "/do Улыбка на лице."
   - НЕ завершай каждый /me отыгровкой /do без необходимости
   - НЕ отыгрывай ВИДИМЫЕ действия: ходьбу, открытие дверей машины, приседания (есть анимации)
   - НЕ отыгрывай бессмысленные проверки: "/me проверил наличие опасности", "/do Место безопасно?"

5. СТРУКТУРА ОТЫГРОВКИ:
   
   ЭТАП 1 - ПОДГОТОВКА:
   ${hasCar 
     ? `
   /me открыл багажник служебного автомобиля и достал медицинскую сумку
   /do Медицинская сумка в руках.`
     : `
   /do На поясе закреплена медицинская аптечка.
   /me снял медицинскую аптечку с пояса
   /do Аптечка в руках.`
   }
   
   ЭТАП 2 - ВЫЗОВ СКОРОЙ (обязательно ПЕРЕД началом ПМП):
   
   Для сотрудников ниже Капитана:
   /me достал телефон и вызвал скорую помощь
   
   Для Капитанов и выше:
   /d [ГУВД-П][ЦГБ-П] Запрашиваю АСМП к "место", причина: описание
   Пример: /d [ГУВД-П][ЦГБ-П] Запрашиваю АСМП к "Зданию полиции г. Приволжск", причина: гражданин без сознания
   
   ЭТАП 3 - ОКАЗАНИЕ ПМП:
   ${hasCar 
     ? '/me открыл медицинскую сумку и достал одноразовые перчатки'
     : '/me открыл аптечку и достал одноразовые перчатки'
   }
   
   Далее продолжи осмотр и помощь
   Максимум 10-12 команд для этапа ПМП

6. НЕВИДИМЫЕ ПРЕДМЕТЫ:
   ОБЯЗАТЕЛЬНО отыгрывай наличие невидимых предметов ПЕРЕД их использованием:
   - Медицинская сумка на плече: "/do Медицинская сумка перекинута через плечо."
   - Аптечка на поясе: "/do На поясе закреплена медицинская аптечка."
   - Перчатки в кармане: "/do В кармане лежат медицинские перчатки."
   
7. ВАРИАЦИИ С ОТВЕТАМИ ПОСТРАДАВШЕГО:
   КРИТИЧЕСКИ ВАЖНО: После КАЖДОГО вопросительного /do ОБЯЗАТЕЛЬНО создавай ДВА варианта ответа!
   НЕ делай вложенные вариации - каждая проверка = отдельный блок вариантов.
   
   ОБЯЗАТЕЛЬНЫЕ ВАРИАЦИИ ДЛЯ:
   - /do Пульс присутствует?
   - /do Дыхание присутствует?
   - /do Реакция на нашатырный спирт есть?
   - /do Пострадавший в сознании?
   - /do Кровотечение уменьшается?
   - /do Кровотечение остановилось?
   - /do Реакция зрачков на свет присутствует?
   - И ЛЮБОЙ другой вопросительный /do!
   
   ПРАВИЛЬНАЯ СТРУКТУРА:
   
   /me приложил два пальца к сонной артерии пострадавшего
   /do Пульс присутствует?
   
   — Если пульс есть:
   /b Пострадавший: /do Да.
   /me продолжил осмотр пострадавшего
   
   — Если пульса нет:
   /b Пострадавший: /do Нет.
   /me начал проводить сердечно-легочную реанимацию
   
   Затем следующая проверка:
   
   /me прижал салфетку к ране
   /do Кровотечение уменьшается?
   
   — Если кровотечение уменьшается:
   /b Пострадавший: /do Да.
   /me продолжил прижимать салфетку
   
   — Если кровотечение не уменьшается:
   /b Пострадавший: /do Нет.
   /me наложил жгут выше места ранения

8. РЕАЛИСТИЧНОСТЬ:
   - Следуй медицинским протоколам
   - Действия должны быть логичными и последовательными
   - Учитывай время выполнения действий
   - Используй вопросительные /do для уточнений

ПРАВИЛЬНЫЕ ПРИМЕРЫ:

ЭТАП 1 - ПОДГОТОВКА:

Вариант 1 — если есть автомобиль:
/me открыл багажник служебного автомобиля и достал медицинскую сумку
/do Медицинская сумка в руках.

Вариант 2 — если машины нет:
/do На поясе закреплена медицинская аптечка.
/me снял медицинскую аптечку с пояса
/do Аптечка в руках.

ЭТАП 2 - ВЫЗОВ СКОРОЙ:

Для сотрудников ниже Капитана:
/me достал телефон и вызвал скорую помощь

Для Капитанов и выше:
/d [ГУВД-П][ЦГБ-П] Запрашиваю АСМП к "Центральной площади г. Приволжск", причина: огнестрельное ранение

ЭТАП 3 - ОКАЗАНИЕ ПМП:

/me открыл медицинскую сумку и достал одноразовые перчатки
/me надел перчатки на руки
/do Что случилось с пострадавшим?
/b Напишите через /do, что с вами произошло
/me приложил два пальца к сонной артерии пострадавшего
/do Пульс присутствует?

— Если пульс есть:
/b Пострадавший: /do Да.
/me продолжил осмотр пострадавшего

— Если пульса нет:
/b Пострадавший: /do Нет.
/me начал проводить сердечно-легочную реанимацию

НЕПРАВИЛЬНЫЕ ПРИМЕРЫ (НЕ ДЕЛАЙ ТАК):

/me направился к служебному транспорту ← видимое действие (ходьба)
/me закрыл дверь автомобиля ← видимое действие (есть анимация)
/me опустился на колено рядом с пострадавшим ← видимое действие (есть анимация приседа)
/me проверил наличие опасности вокруг ← бессмысленная отыгровка
/do Место происшествия безопасно? ← бессмысленная отыгровка
/me достал аптечку ← нет /do о наличии аптечки перед этим
/do Аптечка в руках. ← отыгровка-паразит, и так понятно из /me
/do Передача аптечки. ← отыгровка-паразит
/do Улыбка на лице. ← отыгровка-паразит
/do Пострадавший без сознания. ← отыгровка за другого персонажа
/try проверил пульс и увидел, что пострадавший жив ← нельзя /try для состояния других

ФОРМАТ ОТВЕТА:
Напиши только команды для отыгровки, каждая с новой строки. Без дополнительных пояснений и комментариев.

Создай отыгровку:`
}

/**
 * Парсит сгенерированный текст в структурированный формат
 */
function parseGeneratedText(text: string, scenario: MedicalScenario): GeneratedRoleplay {
  // Убираем лишние пробелы и разбиваем на строки
  const lines = text
    .split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0)
    .filter(line => 
      line.startsWith('/me') || 
      line.startsWith('/do') || 
      line.startsWith('/b') ||
      line.startsWith('/d') ||
      line.includes('Вариант') ||
      line.includes('ЭТАП') ||
      line.includes('Для сотрудников') ||
      line.includes('Для Капитанов') ||
      line.startsWith('Если') ||
      line.startsWith('—')
    )

  // Создаём описание сценария
  const scenarioDescription = buildScenarioDescription(scenario)

  return {
    scenario: scenarioDescription,
    steps: lines
  }
}

/**
 * Создаёт человекочитаемое описание сценария
 */
function buildScenarioDescription(scenario: MedicalScenario): string {
  return scenario.type
}

/**
 * Проверяет валидность API ключа
 */
export function validateApiKey(apiKey: string): boolean {
  // Gemini API ключи обычно начинаются с "AIza" и имеют длину около 39 символов
  return apiKey.startsWith('AIza') && apiKey.length >= 35
}

/**
 * Сохраняет API ключ в localStorage
 */
export function saveApiKey(apiKey: string): void {
  if (typeof window !== 'undefined') {
    localStorage.setItem('gemini_api_key', apiKey)
  }
}

/**
 * Загружает API ключ из localStorage
 */
export function loadApiKey(): string | null {
  if (typeof window !== 'undefined') {
    return localStorage.getItem('gemini_api_key')
  }
  return null
}

/**
 * Удаляет API ключ из localStorage
 */
export function clearApiKey(): void {
  if (typeof window !== 'undefined') {
    localStorage.removeItem('gemini_api_key')
  }
}
