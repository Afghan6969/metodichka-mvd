# üìù –ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–≥–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π

## –í–æ–ø—Ä–æ—Å
> –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π? –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π, –∞ –Ω–∞ —Å–∞–π—Ç–µ –æ–Ω–∏ –µ—Å—Ç—å.

## –û—Ç–≤–µ—Ç

### –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–≥–∏?

–õ–æ–≥–∏ **–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è** –∏ **—á–∏—Ç–∞—é—Ç—Å—è** –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_logs` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

#### 1. **–ó–∞–ø–∏—Å—å –ª–æ–≥–æ–≤** (–≤ API —Ä–æ—É—Ç–∞—Ö)
–ö–∞–∂–¥—ã–π API —Ä–æ—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `user_logs`:

```typescript
// –ü—Ä–∏–º–µ—Ä –∏–∑ app/api/auth/add-user/route.ts
await supabase.from("user_logs").insert([{
  action: "add_user",
  target_user_id: newUser?.id,
  target_user_nickname: nickname,
  performed_by_id: currentUser.id,
  performed_by_nickname: currentUser.nickname,
  details: JSON.stringify({ nickname, username, role }),
  ip_address: ip,
}]);
```

#### 2. **–ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤** (–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ)
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç `UserManagementPage` —á–∏—Ç–∞–µ—Ç –ª–æ–≥–∏ —á–µ—Ä–µ–∑ API:

```typescript
// lib/auth-context.tsx
const res = await fetch("/api/auth/user-logs", { credentials: "include" });
const { data } = await res.json();
setUserLogs(data || []);
```

API —Ä–æ—É—Ç `/api/auth/user-logs` —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î:

```typescript
const { data } = await supabase
  .from('user_logs')
  .select('*')
  .order('created_at', { ascending: false });
```

## –ü–æ—á–µ–º—É –ª–æ–≥–∏ –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –ë–î?

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

#### 1. **RLS (Row Level Security) –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å—å**
–ï—Å–ª–∏ –≤ Supabase –≤–∫–ª—é—á–µ–Ω RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `user_logs`, —Ç–æ –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–ª—é—á–∏—Ç—å RLS –¥–ª—è `user_logs`
```sql
ALTER TABLE user_logs DISABLE ROW LEVEL SECURITY;
```

#### 2. **–û—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è**
–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥ –ù–ï –ø—Ä–æ–≤–µ—Ä—è–ª –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤:
```typescript
// –ë–´–õ–û (–ø–ª–æ—Ö–æ):
await supabase.from("user_logs").insert([...]);
// –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –ª–æ–≥ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è

// –°–¢–ê–õ–û (—Ö–æ—Ä–æ—à–æ):
const { error: logError } = await supabase.from("user_logs").insert([...]);
if (logError) {
  console.error("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞:", logError);
}
```

#### 3. **–ü—Ä–æ–±–ª–µ–º—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏**
–ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `user_logs` –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –Ω–∞ `users`, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –∑–∞–ø–∏—Å—å –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–π—Ç–∏.

#### 4. **–ù–µ—Ç –ø—Ä–∞–≤ —É Service Role Key**
API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SUPABASE_SERVICE_ROLE_KEY` –¥–ª—è –∑–∞–ø–∏—Å–∏. –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤ - –∑–∞–ø–∏—Å—å –Ω–µ –ø—Ä–æ–π–¥–µ—Ç.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤
–í —Ñ–∞–π–ª–∞—Ö:
- `app/api/auth/add-user/route.ts`
- `app/api/auth/update-user/route.ts`
- `app/api/auth/login/route.ts`

–¢–µ–ø–µ—Ä—å –≤—Å–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å:
```typescript
if (logError) {
  console.error("[API] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞:", logError);
  console.error("[API] Log error details:", JSON.stringify(logError, null, 2));
}
```

### 2. –°–æ–∑–¥–∞–Ω SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
–§–∞–π–ª: `scripts/019_check_user_logs_table.sql`

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `user_logs`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ª–æ–≥–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç RLS
- –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üîç –ö–∞–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ Supabase
–ó–∞–π–¥–∏—Ç–µ –≤ **Supabase Dashboard ‚Üí Table Editor ‚Üí user_logs**

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–±–ª–∏—Ü–∞?
- –ï—Å—Ç—å –ª–∏ –≤ –Ω–µ–π –∑–∞–ø–∏—Å–∏?
- –ö–∞–∫–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å?

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
–í **Supabase Dashboard ‚Üí SQL Editor** –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
SELECT COUNT(*) FROM user_logs;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π
SELECT * FROM user_logs ORDER BY created_at DESC LIMIT 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'user_logs';

-- –ï—Å–ª–∏ RLS –≤–∫–ª—é—á–µ–Ω - –æ—Ç–∫–ª—é—á–∏—Ç—å
ALTER TABLE user_logs DISABLE ROW LEVEL SECURITY;
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—Ö–æ–¥ –∏ —Ç.–¥.) –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–ª—è—Ç—å—Å—è –ª–æ–≥–∏:

```
[AddUser API] –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: TestUser
```

–ò–ª–∏ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞:
```
[AddUser API] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞: { ... }
[AddUser API] Log error details: { ... }
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network ‚Üí –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ `/api/auth/user-logs`

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
```json
{
  "data": [
    {
      "id": 123,
      "action": "add_user",
      "target_user_nickname": "TestUser",
      ...
    }
  ]
}
```

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –≤ Supabase
```sql
-- –û—Ç–∫–ª—é—á–∏—Ç—å RLS –¥–ª—è user_logs
ALTER TABLE user_logs DISABLE ROW LEVEL SECURITY;

-- –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏
DROP POLICY IF EXISTS "Enable read access for all users" ON user_logs;
DROP POLICY IF EXISTS "Users can read all logs" ON user_logs;
DROP POLICY IF EXISTS "Allow read access to all logs" ON user_logs;
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å
npm run dev
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
1. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –Ω–∞ —Å–∞–π—Ç
2. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥: `[AddUser API] –õ–æ–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase ‚Üí Table Editor ‚Üí user_logs - –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ –≤ "–ñ—É—Ä–Ω–∞–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π" - –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–π –ª–æ–≥

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã user_logs

```sql
CREATE TABLE user_logs (
  id SERIAL PRIMARY KEY,
  action TEXT NOT NULL,                    -- –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (add_user, update_user, login, etc.)
  target_user_id UUID,                     -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ
  target_user_nickname TEXT,               -- –ù–∏–∫–Ω–µ–π–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  performed_by_id UUID,                    -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
  performed_by_nickname TEXT,              -- –ù–∏–∫–Ω–µ–π–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
  details TEXT,                            -- JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –¥–µ–π—Å—Ç–≤–∏—è
  ip_address TEXT,                         -- IP –∞–¥—Ä–µ—Å
  created_at TIMESTAMP DEFAULT NOW()       -- –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è
);
```

## üéØ –ò—Ç–æ–≥

**–õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `user_logs` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase.**

–ï—Å–ª–∏ –ª–æ–≥–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `SUPABASE_SERVICE_ROLE_KEY` –≤ `.env.local`
4. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏–∑ `scripts/019_check_user_logs_table.sql`

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤—Å–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.
