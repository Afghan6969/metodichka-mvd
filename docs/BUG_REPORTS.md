# Система отчетов о багах и предложениях

## Описание

Система позволяет пользователям отправлять отчеты о найденных багах и предложения по улучшению системы. Super-admin имеет полный доступ к управлению всеми отчетами.

## Функциональность

### Для всех пользователей

- **Создание отчетов**: Пользователи могут создавать отчеты двух типов:
  - **Баг** - сообщение об ошибке в системе
  - **Предложение** - идея по улучшению функционала

- **Просмотр своих отчетов**: Каждый пользователь видит только свои отчеты

- **Отслеживание статуса**: Пользователи могут видеть текущий статус своих отчетов:
  - Новый
  - В работе
  - Решен
  - Отклонен

### Для Super-Admin

- **Просмотр всех отчетов**: Доступ ко всем отчетам от всех пользователей

- **Фильтрация**:
  - По типу (баги/предложения)
  - По статусу (новые/в работе/решенные/отклоненные)

- **Управление отчетами**:
  - Изменение статуса отчета
  - Изменение приоритета (низкий/средний/высокий/критический)
  - Удаление отчетов

- **Информация об авторе**: Видна информация о пользователе, создавшем отчет

## Структура базы данных

### Таблица `bug_reports`

```sql
- id: UUID (Primary Key)
- user_id: UUID (Foreign Key -> auth.users)
- type: TEXT ('bug' | 'suggestion')
- title: TEXT (заголовок отчета)
- description: TEXT (подробное описание)
- status: TEXT ('new' | 'in_progress' | 'resolved' | 'rejected')
- priority: TEXT ('low' | 'medium' | 'high' | 'critical')
- created_at: TIMESTAMPTZ
- updated_at: TIMESTAMPTZ
- resolved_at: TIMESTAMPTZ (nullable)
- resolved_by: UUID (nullable, Foreign Key -> auth.users)
```

### Политики безопасности (RLS)

1. Пользователи могут просматривать только свои отчеты
2. Пользователи могут создавать отчеты
3. Super-admin может просматривать все отчеты
4. Super-admin может обновлять все отчеты
5. Super-admin может удалять отчеты

## API Endpoints

### GET `/api/bug-reports`

Получение списка отчетов.

**Ответ**:
```json
{
  "reports": [...],
  "isSuperAdmin": boolean
}
```

- Обычные пользователи получают только свои отчеты
- Super-admin получает все отчеты с информацией об авторах

### POST `/api/bug-reports`

Создание нового отчета.

**Тело запроса**:
```json
{
  "type": "bug" | "suggestion",
  "title": "string (min 5 символов)",
  "description": "string (min 10 символов)"
}
```

**Ответ**:
```json
{
  "report": {...}
}
```

### PATCH `/api/bug-reports/[id]`

Обновление отчета (только для super-admin).

**Тело запроса**:
```json
{
  "status": "new" | "in_progress" | "resolved" | "rejected",
  "priority": "low" | "medium" | "high" | "critical"
}
```

**Ответ**:
```json
{
  "report": {...}
}
```

### DELETE `/api/bug-reports/[id]`

Удаление отчета (только для super-admin).

**Ответ**:
```json
{
  "success": true
}
```

## Установка

### 1. Выполнить SQL миграцию

Запустите скрипт `scripts/015_create_bug_reports.sql` в Supabase SQL Editor:

```bash
# Или через CLI
supabase db push
```

### 2. Проверить доступ

Убедитесь, что пользователь с ролью `super-admin` видит пункт "Баг репорт" в боковом меню.

## Использование

### Создание отчета

1. Нажмите кнопку "Создать отчет"
2. Выберите тип (Баг или Предложение)
3. Введите заголовок (минимум 5 символов)
4. Введите описание (минимум 10 символов)
5. Нажмите "Отправить"

### Управление отчетами (Super-Admin)

1. Откройте страницу "Баг репорт" из бокового меню
2. Используйте фильтры для поиска нужных отчетов
3. Измените статус или приоритет через выпадающие списки
4. При необходимости удалите отчет кнопкой с иконкой корзины

## Валидация

- **Заголовок**: минимум 5 символов
- **Описание**: минимум 10 символов
- **Тип**: только 'bug' или 'suggestion'
- **Статус**: только 'new', 'in_progress', 'resolved', 'rejected'
- **Приоритет**: только 'low', 'medium', 'high', 'critical'

## Автоматизация

- При изменении статуса на "resolved" автоматически устанавливаются:
  - `resolved_at` - текущая дата и время
  - `resolved_by` - ID пользователя, изменившего статус
  
- При любом обновлении записи автоматически обновляется `updated_at`

## Безопасность

- Все операции проверяются на уровне API
- Row Level Security (RLS) обеспечивает изоляцию данных
- Super-admin проверяется по полю `role` в таблице `users`
- Все входные данные валидируются перед сохранением
