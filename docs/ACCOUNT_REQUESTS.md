# Система запросов на создание аккаунта

## Обзор

Система запросов на создание аккаунта позволяет игрокам отправлять запросы на регистрацию, которые затем рассматриваются лидерами ПГС и ГС. Система включает защиту от спама и автоматическое создание аккаунтов после одобрения.

## Основные возможности

### 1. Для игроков
- Заполнение формы запроса с указанием ника, логина, пароля и фракции
- CAPTCHA для защиты от ботов
- Валидация полей в реальном времени
- Уведомление об успешной отправке запроса

### 2. Для лидеров ПГС и ГС
- Просмотр всех запросов с фильтрацией по статусу
- Одобрение или отклонение запросов с комментариями
- Автоматическое создание пользователя при одобрении
- Логирование всех действий

### 3. Защита от спама
- **Rate Limiting**: максимум 3 запроса с одного IP за 24 часа
- **CAPTCHA**: математическая задача для проверки человека
- **Проверка дубликатов**: нельзя создать запрос с существующим логином
- **Валидация полей**: проверка длины и формата всех полей
- **IP логирование**: отслеживание IP адресов для анализа

## Установка

### 1. Выполните SQL миграцию

Запустите SQL скрипт в Supabase SQL Editor:

```bash
# Файл: scripts/008_create_account_requests_table.sql
```

Этот скрипт создаст:
- Таблицу `account_requests` для хранения запросов
- Таблицу `request_rate_limits` для rate limiting
- Функцию `check_rate_limit()` для проверки лимитов
- Функцию `auto_create_user_from_request()` для автоматического создания пользователей
- Триггер для автоматического создания пользователя при одобрении
- RLS политики для безопасности

### 2. Проверьте структуру таблицы users

Убедитесь, что таблица `users` имеет следующие поля:
- `id` (UUID, PRIMARY KEY)
- `nickname` (TEXT)
- `login` (TEXT, UNIQUE)
- `password_hash` (TEXT)
- `role` (TEXT)
- `status` (TEXT, default: 'active')
- `created_by` (UUID, опционально)

### 3. API маршруты

Система использует следующие API endpoints:

#### POST `/api/account-requests/submit`
Отправка запроса на создание аккаунта.

**Body:**
```json
{
  "nickname": "string",
  "login": "string",
  "password": "string",
  "role": "string (optional)",
  "captchaAnswer": "string",
  "captchaToken": "string"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Запрос успешно отправлен",
  "requestId": "uuid"
}
```

#### GET `/api/account-requests/list`
Получение списка запросов (только для лидеров ПГС и ГС).

**Query params:**
- `status` (optional): `pending`, `approved`, `rejected`
- `page` (optional): номер страницы (default: 1)
- `limit` (optional): количество на странице (default: 20)

**Response:**
```json
{
  "success": true,
  "requests": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### POST `/api/account-requests/review`
Одобрение или отклонение запроса (только для лидеров ПГС и ГС).

**Body:**
```json
{
  "requestId": "uuid",
  "action": "approve" | "reject",
  "comment": "string (optional)"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Request approved successfully",
  "request": {...}
}
```

#### GET `/api/account-requests/generate-captcha`
Генерация CAPTCHA.

**Response:**
```json
{
  "success": true,
  "question": "Сколько будет 5 + 3?",
  "token": "8"
}
```

## Использование

### Для игроков

1. Перейдите на страницу `/account-request`
2. Заполните форму:
   - **Ник**: минимум 3 символа, только буквы, цифры, пробелы, дефисы и подчеркивания
   - **Логин**: минимум 3 символа, только латинские буквы, цифры, дефисы и подчеркивания
   - **Пароль**: минимум 6 символов
   - **Фракция/Роль**: опционально
3. Решите CAPTCHA
4. Нажмите "Отправить запрос"
5. Дождитесь рассмотрения запроса лидерами

### Для лидеров ПГС и ГС

1. Перейдите на страницу `/admin/account-requests`
2. Используйте вкладки для фильтрации запросов:
   - **Ожидают**: запросы, требующие рассмотрения
   - **Одобренные**: одобренные запросы
   - **Отклоненные**: отклоненные запросы
   - **Все**: все запросы
3. Для каждого запроса вы можете:
   - Просмотреть детали (ник, логин, роль, IP, дата создания)
   - Одобрить запрос (аккаунт будет создан автоматически)
   - Отклонить запрос с комментарием
4. Все действия логируются в таблицу `user_logs`

## Защита от спама

### Rate Limiting

Система ограничивает количество запросов с одного IP адреса:
- **Лимит**: 3 запроса за 24 часа
- **Блокировка**: при превышении лимита IP блокируется на 24 часа
- **Сброс**: счетчик сбрасывается через 24 часа после последнего запроса

### CAPTCHA

Простая математическая CAPTCHA для защиты от ботов:
- Генерируется случайное математическое выражение (сложение)
- Пользователь должен ввести правильный ответ
- CAPTCHA обновляется при каждой неудачной попытке

**Рекомендация для production**: замените на Google reCAPTCHA или hCaptcha для более надежной защиты.

### Валидация полей

Все поля проходят валидацию на клиенте и сервере:

**Ник:**
- Минимум 3 символа, максимум 50
- Только буквы (латиница и кириллица), цифры, пробелы, дефисы и подчеркивания
- Регулярное выражение: `^[a-zA-Zа-яА-ЯёЁ0-9_\-\s]+$`

**Логин:**
- Минимум 3 символа, максимум 30
- Только латинские буквы, цифры, дефисы и подчеркивания
- Регулярное выражение: `^[a-zA-Z0-9_\-]+$`
- Автоматически преобразуется в нижний регистр

**Пароль:**
- Минимум 6 символов, максимум 100
- Хэшируется с помощью bcrypt перед сохранением

### Проверка дубликатов

Система проверяет:
1. Нет ли уже пользователя с таким логином в таблице `users`
2. Нет ли pending или approved запроса с таким логином в таблице `account_requests`
3. Нет ли уже pending запроса с того же IP адреса за последние 24 часа

## Безопасность

### Хэширование паролей

Все пароли хэшируются с помощью bcrypt (10 раундов) перед сохранением в базу данных.

### Row Level Security (RLS)

**Таблица `account_requests`:**
- **INSERT**: любой может создавать запросы
- **SELECT**: только лидеры ПГС и ГС могут просматривать запросы
- **UPDATE**: только лидеры ПГС и ГС могут обновлять запросы

**Таблица `request_rate_limits`:**
- Доступна только для service role (backend)

### Аутентификация

Все административные операции требуют:
1. Валидный JWT токен в cookie `auth_token`
2. Роль пользователя: "Лидер ПГС" или "ГС"
3. Статус пользователя: "active"

## Логирование

Все действия с запросами логируются в таблицу `user_logs`:

**Типы действий:**
- `account_request_approved`: запрос одобрен
- `account_request_rejected`: запрос отклонен

**Логируемая информация:**
- Кто выполнил действие (performed_by_id, performed_by_nickname)
- Над кем выполнено действие (target_user_nickname)
- Детали действия (комментарий, логин)
- IP адрес
- Временная метка

## Автоматическое создание пользователя

При одобрении запроса срабатывает триггер `trigger_auto_create_user_from_request`, который:
1. Проверяет, что статус изменился с `pending` на `approved`
2. Создает новую запись в таблице `users` с данными из запроса
3. Устанавливает `created_by` равным ID проверяющего

## Структура базы данных

### Таблица `account_requests`

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| nickname | TEXT | Игровой ник |
| login | TEXT | Логин (уникальный) |
| password_hash | TEXT | Хэш пароля |
| role | TEXT | Фракция/роль (опционально) |
| status | TEXT | Статус: pending, approved, rejected |
| comment | TEXT | Комментарий проверяющего |
| created_at | TIMESTAMP | Дата создания |
| reviewed_by | UUID | ID проверяющего |
| reviewed_at | TIMESTAMP | Дата рассмотрения |
| ip_address | TEXT | IP адрес отправителя |
| user_agent | TEXT | User agent браузера |

### Таблица `request_rate_limits`

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Первичный ключ |
| ip_address | TEXT | IP адрес |
| request_count | INTEGER | Количество запросов |
| last_request_at | TIMESTAMP | Время последнего запроса |
| blocked_until | TIMESTAMP | Блокировка до (если превышен лимит) |

## Настройка

### Изменение лимита запросов

Отредактируйте функцию `check_rate_limit` в SQL:

```sql
DECLARE
  v_time_window INTERVAL := '24 hours';  -- Временное окно
  v_max_requests INTEGER := 3;           -- Максимум запросов
```

### Улучшение CAPTCHA

Для production рекомендуется использовать Google reCAPTCHA v3:

1. Зарегистрируйтесь на https://www.google.com/recaptcha/admin
2. Получите site key и secret key
3. Установите пакет: `npm install react-google-recaptcha`
4. Обновите компонент `AccountRequestForm`
5. Обновите API route `/api/account-requests/submit` для проверки токена

## Troubleshooting

### Ошибка: "Превышен лимит запросов"

**Причина**: IP адрес отправил более 3 запросов за 24 часа.

**Решение**: 
- Подождите 24 часа
- Или очистите запись в таблице `request_rate_limits` для этого IP (только для администраторов)

### Ошибка: "Логин уже занят"

**Причина**: Пользователь с таким логином уже существует или есть pending/approved запрос.

**Решение**: Выберите другой логин.

### Ошибка: "Access denied"

**Причина**: Пользователь не имеет роли "Лидер ПГС" или "ГС".

**Решение**: Обратитесь к администратору для получения необходимых прав.

### Аккаунт не создается после одобрения

**Причина**: Триггер не сработал или произошла ошибка.

**Решение**:
1. Проверьте логи Supabase
2. Убедитесь, что триггер создан: `SELECT * FROM pg_trigger WHERE tgname = 'trigger_auto_create_user_from_request'`
3. Проверьте, что функция `auto_create_user_from_request` существует

## Дополнительные улучшения

### Email уведомления

Добавьте отправку email при изменении статуса запроса:
1. Настройте SMTP в Supabase
2. Создайте функцию для отправки email
3. Добавьте вызов функции в триггер или API route

### Telegram уведомления

Интегрируйте Telegram Bot для уведомлений:
1. Создайте бота через @BotFather
2. Добавьте поле `telegram_id` в таблицу `account_requests`
3. Отправляйте уведомления через Telegram Bot API

### Расширенная аналитика

Добавьте дашборд с метриками:
- Количество запросов по дням
- Процент одобрения/отклонения
- Топ IP адресов по количеству запросов
- Среднее время рассмотрения запроса

## Поддержка

Если у вас возникли вопросы или проблемы, создайте issue в репозитории проекта.
